<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LMS Admin – Full Management Suite</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    :root{
      --primary:#2563eb;--primary-hover:#1d4ed8;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;
      --gray:#64748b;--bg:#f8fafc;--card-bg:#ffffff;--text-main:#0f172a;--sidebar-w:260px;
      --border:#e2e8f0;--shadow:0 4px 6px -1px rgb(0 0 0 / 0.1),0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    *{box-sizing:border-box;transition:background-color .2s,color .2s}
    body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);margin:0;color:var(--text-main);height:100vh;overflow:hidden}
    .layout{display:flex;height:100vh}
    aside{background:var(--card-bg);border-right:1px solid var(--border);padding:1.5rem 0;width:var(--sidebar-w);z-index:100;display:flex;flex-direction:column;box-shadow:var(--shadow)}
    .logo{padding:0 1.5rem 2rem;font-size:1.25rem;font-weight:800;color:var(--primary);display:flex;align-items:center;gap:12px}
    nav a{display:flex;align-items:center;padding:.8rem 1.2rem;color:var(--gray);text-decoration:none;font-weight:500;cursor:pointer;font-size:14px;margin:4px 12px;border-radius:12px;position:relative}
    nav a.active{background:#eff6ff;color:var(--primary);font-weight:600}
    
    .unread-badge {
      position: absolute; right: 12px; background: var(--danger); color: white;
      font-size: 10px; padding: 2px 7px; border-radius: 10px; display: none; font-weight: 800;
    }

    .main-wrapper{flex:1; display:flex; flex-direction:column; min-width: 0;}
    header{background:var(--card-bg);padding:0 2.5rem;display:flex;justify-content:space-between;align-items:center;min-height:70px;border-bottom:1px solid var(--border)}
    main{padding:2.5rem;overflow-y:auto;flex:1}
    .card{background:var(--card-bg);border-radius:16px;border:1px solid var(--border);padding:1.8rem;margin-bottom:1.5rem;box-shadow:0 1px 3px 0 rgb(0 0 0 / .1)}
    
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
    .stat-card{background:var(--primary);color:white;padding:1.5rem;border-radius:12px;text-align:center}
    .stat-card h4{margin:0;font-size:0.9rem;opacity:0.8}
    .stat-card p{margin:10px 0 0;font-size:2rem;font-weight:800}

    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:1.2rem;text-align:left;border-bottom:1px solid var(--border)}
    th{background:var(--bg);font-size:.7rem;text-transform:uppercase;color:var(--gray);font-weight:700}
    button{background:var(--primary);color:#fff;border:none;padding:.65rem 1.4rem;border-radius:9999px;cursor:pointer;font-weight:600;font-size:14px;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    button.success{background:var(--success)}
    button.danger{background:var(--danger)}
    button.secondary{background:#e2e8f0; color:var(--text-main)}
    button:disabled{opacity:0.6; cursor:not-allowed}
    input,select,textarea{padding:.75rem;border:1px solid var(--border);border-radius:10px;width:100%;margin-bottom:12px;background:var(--bg);color:var(--text-main);font-family: inherit;}
    .label{font-size:11px;color:var(--gray);font-weight:700;display:block;margin-bottom:6px;text-transform:uppercase}
    .content-section{display:none}
    .content-section.active{display:block}
    
    /* MODAL STYLES */
    #modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
      display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    .modal-content {
      background: white; padding: 2.5rem; border-radius: 20px; width: 100%; max-width: 400px;
      text-align: center; box-shadow: var(--shadow); transform: scale(0.9); transition: 0.2s;
    }
    #modal-overlay.active .modal-content { transform: scale(1); }
    .status-pill { font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-active { background: #d1fae5; color: #065f46; }

    /* CHAT BUBBLES */
    #chat-box { height: 450px; overflow-y: auto; padding: 2rem; background: #f1f5f9; border-radius: 16px; display: flex; flex-direction: column; gap: 16px; border: 1px solid var(--border); }
    .chat-msg { max-width: 75%; padding: 12px 16px; font-size: 14px; position: relative; line-height: 1.5; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .chat-msg.admin { align-self: flex-end; background: var(--primary); color: white; border-radius: 18px 18px 2px 18px; }
    .chat-msg.student { align-self: flex-start; background: white; color: var(--text-main); border-radius: 18px 18px 18px 2px; }
    .chat-sender { display: block; font-size: 11px; font-weight: 700; margin-bottom: 4px; opacity: 0.9; }
    .chat-time { display: block; font-size: 10px; margin-top: 6px; opacity: 0.7; text-align: right; }
    
    .chat-actions { display: flex; gap: 4px; position: absolute; top: 0; right: -80px; opacity: 0; transition: 0.3s; }
    .chat-msg.admin .chat-actions { right: auto; left: -80px; }
    .chat-msg:hover .chat-actions { opacity: 1; }
    .chat-action-btn { background: white; border: 1px solid var(--border); padding: 6px; border-radius: 50%; cursor: pointer; color: var(--gray); display: flex; align-items: center; box-shadow: var(--shadow); }
    .chat-action-btn:hover { color: var(--primary); transform: scale(1.1); }
    .chat-action-btn.del:hover { color: var(--danger); }

    /* TIMETABLE */
    .tt-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
    .tt-day-col { background: var(--bg); border-radius: 8px; padding: 10px; border: 1px solid var(--border); min-height: 150px; }
    .tt-day-title { text-align: center; font-weight: 800; font-size: 11px; margin-bottom: 10px; color: var(--primary); }
    .tt-slot { background: var(--card-bg); padding: 8px; border-radius: 6px; border-left: 3px solid var(--primary); margin-bottom: 5px; font-size: 11px; position: relative; box-shadow: var(--shadow);}
    .tt-del { position: absolute; top: 2px; right: 5px; color: var(--danger); cursor: pointer; font-size: 14px; }
    
    #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 12px 24px; border-radius: 50px; font-weight: 600; box-shadow: var(--shadow); z-index: 9999; display: none; }
    .show-toast { display: block !important; animation: fadeInOut 3s forwards; }
    @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -20px); } 15% { opacity: 1; transform: translate(-50%, 0); } 85% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -20px); } }
    .view-link { color: var(--primary); text-decoration: none; font-weight: 700; display: flex; align-items: center; gap: 4px; }
  </style>
</head>
<body>

<div id="toast">Action Successful!</div>

<div id="modal-overlay">
  <div class="modal-content">
    <div id="modal-icon" style="margin-bottom:1rem"></div>
    <h3 id="modal-title">Notification</h3>
    <div id="modal-body-wrapper">
        <p id="modal-body" style="color:var(--gray); line-height:1.5; margin-bottom:1rem"></p>
    </div>
    <div id="modal-footer" style="display:flex; gap:10px; justify-content:center"></div>
  </div>
</div>

<div class="layout">
  <aside>
    <div class="logo"><i data-lucide="layers"></i><span>LMS Admin</span></div>
    <nav id="sidebar-nav" style="display:none">
      <ul>
        <li><a class="nav-link active" data-target="invite-sec"><i data-lucide="user-plus"></i><span>Add Learner</span></a></li>
        <li><a class="nav-link" data-target="announcement-sec"><i data-lucide="megaphone"></i><span>Announcements</span></a></li>
        <li><a class="nav-link" data-target="directory-sec"><i data-lucide="users"></i><span>Directory</span></a></li>
        <li><a class="nav-link" data-target="materials-sec"><i data-lucide="book-open"></i><span>Materials</span></a></li>
        <li><a class="nav-link" data-target="assignments-sec"><i data-lucide="file-text"></i><span>Assignments</span></a></li>
        <li><a class="nav-link" data-target="timetable-sec"><i data-lucide="calendar"></i><span>Timetable</span></a></li>
        <li><a class="nav-link" data-target="chats-sec" id="nav-chat"><i data-lucide="message-square"></i><span>Chat</span> <span id="unread-count" class="unread-badge">0</span></a></li>
        <li><a class="nav-link" data-target="analytics-sec"><i data-lucide="bar-chart-3"></i><span>Analytics</span></a></li>
      </ul>
    </nav>
  </aside>

  <div class="main-wrapper">
    <header>
      <h2 id="view-title">Add Learner</h2>
      <button id="signOutBtn" style="display:none;background:transparent;color:var(--text-main);border:1px solid var(--border)">Sign Out</button>
    </header>

    <main>
      <div id="auth-section" class="card" style="max-width:400px;margin:5rem auto;text-align:center">
        <h1>Admin Portal</h1>
        <button id="googleSignInBtn" style="width:100%"><i data-lucide="log-in"></i> Sign in with Google</button>
      </div>

      <div id="dashboard" style="display:none">
        
        <section id="invite-sec" class="content-section active">
          <div class="card">
            <h3>Enroll Learner</h3>
            <label class="label">Email Address</label>
            <input type="email" id="newLearnerEmail" placeholder="student@example.com">
            <label class="label">Assigned Course</label>
            <input list="qualOptions" id="qualSelect" placeholder="Select or type a course...">
            <datalist id="qualOptions"></datalist>
            <label class="label">Subjects / Modules</label>
            <textarea id="learnerSubjects" rows="3" placeholder="Enter subjects"></textarea>
            <button id="provisionBtn" class="success" style="width:100%">Complete Enrollment</button>
          </div>
        </section>

        <section id="announcement-sec" class="content-section">
          <div class="card">
            <h3>Post New Announcement</h3>
            <label class="label">Title</label>
            <input type="text" id="annTitle" placeholder="Important Update">
            <label class="label">Content</label>
            <textarea id="annBody" rows="4" placeholder="Announcement details..."></textarea>
            <button id="btnPostAnn" class="success" style="width:100%">Publish Announcement</button>
          </div>
          <div class="card">
            <h3>Recent Announcements</h3>
            <table><thead><tr><th>Title</th><th>Date</th><th>Action</th></tr></thead><tbody id="announcementList"></tbody></table>
          </div>
        </section>

        <section id="directory-sec" class="content-section">
          <div class="card">
            <table><thead><tr><th>Email</th><th>Qual</th><th>Status</th><th>Action</th></tr></thead><tbody id="directoryList"></tbody></table>
          </div>
        </section>

        <section id="analytics-sec" class="content-section">
          <div class="stat-grid">
            <div class="stat-card"><h4>Total Learners</h4><p id="stat-enrollment">0</p></div>
            <div class="stat-card" style="background:var(--success)"><h4>Work Submissions</h4><p id="stat-submissions">0</p></div>
          </div>
          <div class="card">
            <h3>Submission Tracker</h3>
            <table><thead><tr><th>Student</th><th>Assignment</th><th>Date</th><th>File</th><th>Action</th></tr></thead><tbody id="submissionTable"></tbody></table>
          </div>
        </section>

        <section id="materials-sec" class="content-section">
          <div class="card">
            <h3>Upload Learning Materials</h3>
            <input type="text" id="matTitle" placeholder="Title">
            <label class="label">Course</label>
            <input list="qualOptions" id="matQual" placeholder="Select course...">
            <input type="file" id="matFileInput" accept=".pdf" style="margin-bottom: 20px;">
            <button id="btnPostMat" class="success" style="width:100%">Post Material</button>
          </div>
        </section>

        <section id="assignments-sec" class="content-section">
          <div class="card">
            <h3>Issue Assignment</h3>
            <input type="text" id="assTitle" placeholder="Assignment Title">
            <label class="label">Course</label>
            <input list="qualOptions" id="assQual" placeholder="Select course...">
            <label class="label">Due Date</label><input type="date" id="assDate">
            <input type="file" id="assFileInput" accept=".pdf" style="margin-bottom: 20px;">
            <button id="btnPostAss" class="success" style="width:100%">Assign Work</button>
          </div>
        </section>

        <section id="timetable-sec" class="content-section">
          <div class="card">
            <h3>Add Schedule</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
              <select id="ttDay"><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option><option>Friday</option></select>
              <input type="time" id="ttTime">
              <input type="text" id="ttSubject" placeholder="Subject">
            </div>
            <button id="btnAddTT" class="success" style="width:100%;margin-top:10px">Add Slot</button>
          </div>
          <div class="tt-grid">
            <div class="tt-day-col" data-day="Monday"><div class="tt-day-title">Mon</div></div>
            <div class="tt-day-col" data-day="Tuesday"><div class="tt-day-title">Tue</div></div>
            <div class="tt-day-col" data-day="Wednesday"><div class="tt-day-title">Wed</div></div>
            <div class="tt-day-col" data-day="Thursday"><div class="tt-day-title">Thu</div></div>
            <div class="tt-day-col" data-day="Friday"><div class="tt-day-title">Fri</div></div>
          </div>
        </section>

        <section id="chats-sec" class="content-section">
          <div class="card">
            <div id="chat-box"></div>
            <div style="display:flex;gap:10px">
              <input type="text" id="chatInput" style="margin-bottom:0" placeholder="Type message...">
              <button id="btnSendChat">Send</button>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>
</div>

<script type="module">
  import {initializeApp} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {getAuth,signInWithPopup,GoogleAuthProvider,onAuthStateChanged,signOut} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import {getDatabase,ref,push,onValue,remove,update,serverTimestamp} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const firebaseConfig={
    apiKey:"AIzaSyDLvkRwSpd-hbPaDP31pV1H-4N5_Re-_xc",
    authDomain:"learnermanagementsystem-f3b6a.firebaseapp.com",
    databaseURL:"https://learnermanagementsystem-f3b6a-default-rtdb.firebaseio.com",
    projectId:"learnermanagementsystem-f3b6a"
  };

  const app=initializeApp(firebaseConfig);
  const auth=getAuth(app);
  const db=getDatabase(app);
  lucide.createIcons();

  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dsbzvgotw/upload";
  const CLOUDINARY_PRESET = "alinamodiba";
  const courses = ["BCom Accounting", "BSc Computer Science", "LLB Law", "Diploma in IT"];
  
  // --- MODAL SYSTEM ---
  function showModal({title, body, type, onConfirm, isEdit = false, currentVal = ""}) {
    const overlay = document.getElementById('modal-overlay');
    const icon = document.getElementById('modal-icon');
    const footer = document.getElementById('modal-footer');
    const bodyEl = document.getElementById('modal-body');
    const wrapper = document.getElementById('modal-body-wrapper');
    
    document.getElementById('modal-title').innerText = title;
    bodyEl.innerText = body;
    footer.innerHTML = '';
    
    const oldInput = document.getElementById('modal-input-field');
    if(oldInput) oldInput.remove();

    if(isEdit) {
        icon.innerHTML = '<i data-lucide="edit-3" style="color:var(--primary); width:48px; height:48px"></i>';
        const input = document.createElement('input');
        input.id = 'modal-input-field';
        input.type = 'text';
        input.value = currentVal;
        input.style.marginTop = "15px";
        wrapper.appendChild(input);

        const cancelBtn = document.createElement('button');
        cancelBtn.innerText = "Cancel"; cancelBtn.className = "secondary";
        cancelBtn.onclick = () => overlay.style.display = 'none';
        
        const saveBtn = document.createElement('button');
        saveBtn.innerText = "Save Changes"; saveBtn.className = "success";
        saveBtn.onclick = () => { onConfirm(input.value); overlay.style.display = 'none'; };
        footer.append(cancelBtn, saveBtn);
    } else if(type === 'confirm') {
      icon.innerHTML = '<i data-lucide="help-circle" style="color:var(--warning); width:48px; height:48px"></i>';
      const cancelBtn = document.createElement('button');
      cancelBtn.innerText = "Cancel"; cancelBtn.className = "secondary";
      cancelBtn.onclick = () => overlay.style.display = 'none';
      
      const okBtn = document.createElement('button');
      okBtn.innerText = "Confirm Action"; okBtn.className = "danger";
      okBtn.onclick = () => { onConfirm(); overlay.style.display = 'none'; };
      footer.append(cancelBtn, okBtn);
    } else {
      icon.innerHTML = '<i data-lucide="check-circle" style="color:var(--success); width:48px; height:48px"></i>';
      const closeBtn = document.createElement('button');
      closeBtn.innerText = "Close"; closeBtn.className = "success";
      closeBtn.onclick = () => overlay.style.display = 'none';
      footer.append(closeBtn);
    }
    
    overlay.style.display = 'flex';
    lucide.createIcons();
  }

  function showToast(msg, color = "#10b981") {
    const toast = document.getElementById('toast');
    toast.innerText = msg;
    toast.style.background = color;
    toast.classList.add('show-toast');
    setTimeout(() => { toast.classList.remove('show-toast'); }, 3000);
  }

  onAuthStateChanged(auth, user => {
    document.getElementById('auth-section').style.display=user?'none':'block';
    document.getElementById('dashboard').style.display=user?'block':'none';
    document.getElementById('sidebar-nav').style.display=user?'block':'none';
    document.getElementById('signOutBtn').style.display=user?'block':'none';
    if(user) initApp();
  });

  async function uploadToCloudinary(file) {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_PRESET);
    const resp = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
    const data = await resp.json();
    return data.secure_url;
  }

  function initApp() {
    const datalist = document.getElementById('qualOptions');
    datalist.innerHTML = courses.map(c => `<option value="${c}">${c}</option>`).join('');

    // Learners & Submissions logic same as previous...
    onValue(ref(db, 'learners'), snap => {
      document.getElementById('stat-enrollment').innerText = snap.size || 0;
      const list = document.getElementById('directoryList'); list.innerHTML = '';
      snap.forEach(c => {
        const d = c.val();
        list.innerHTML += `<tr><td>${d.email}</td><td>${d.assignedQual}</td><td><span class="status-pill ${d.lastLogin?'status-active':'status-pending'}">${d.lastLogin?'Active':'Pending'}</span></td><td><button class="danger" onclick="deleteLearnerConfirm('${c.key}')">Remove</button></td></tr>`;
      });
    });

    onValue(ref(db, 'submissions'), snap => {
      document.getElementById('stat-submissions').innerText = snap.size || 0;
      const table = document.getElementById('submissionTable'); table.innerHTML = '';
      snap.forEach(c => {
        const d = c.val();
        table.innerHTML += `<tr><td>${d.studentEmail}</td><td>${d.assignmentTitle}</td><td>${new Date(d.timestamp).toLocaleDateString()}</td><td>PDF</td><td><a href="${d.link}" target="_blank" class="view-link">Open</a></td></tr>`;
      });
      lucide.createIcons();
    });

    // Announcements listener
    onValue(ref(db, 'announcements'), snap => {
      const list = document.getElementById('announcementList'); list.innerHTML = '';
      snap.forEach(c => {
        const d = c.val();
        const date = d.timestamp ? new Date(d.timestamp).toLocaleDateString() : 'Now';
        list.innerHTML += `<tr><td>${d.title}</td><td>${date}</td><td><button class="danger" onclick="deleteItemConfirm('announcements/${c.key}', 'Announcement')">Delete</button></td></tr>`;
      });
    });

    onValue(ref(db, 'timetable'), snap => {
      document.querySelectorAll('.tt-day-col').forEach(col => {
        const title = col.querySelector('.tt-day-title'); col.innerHTML = ''; col.appendChild(title);
      });
      snap.forEach(c => {
        const d = c.val(); const col = document.querySelector(`.tt-day-col[data-day="${d.day}"]`);
        if(col) col.innerHTML += `<div class="tt-slot"><b>${d.subject}</b><br>${d.time}<i class="tt-del" onclick="deleteItemConfirm('timetable/${c.key}', 'Slot')">×</i></div>`;
      });
    });

    onValue(ref(db, 'chats'), snap => {
      const box = document.getElementById('chat-box'); box.innerHTML = '';
      snap.forEach(c => {
        const d = c.val(); 
        const isSelf = d.sender === auth.currentUser.email;
        box.innerHTML += `
          <div class="chat-msg ${isSelf?'admin':'student'}">
            <div class="chat-actions">
                <button class="chat-action-btn" onclick="editChatModal('${c.key}', \`${d.text}\`)"><i data-lucide="edit-3" style="width:14px"></i></button>
                <button class="chat-action-btn del" onclick="deleteChatMessage('${c.key}')"><i data-lucide="trash-2" style="width:14px"></i></button>
            </div>
            <span class="chat-sender">${isSelf?'Admin':d.sender}</span>
            <div class="chat-text">${d.text}</div>
            <span class="chat-time">${d.timestamp?new Date(d.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'...'}</span>
          </div>`;
      });
      box.scrollTop = box.scrollHeight;
      lucide.createIcons();
    });
  }

  // --- ACTIONS ---
  document.getElementById('btnPostAnn').onclick = async () => {
    const title = document.getElementById('annTitle').value;
    const body = document.getElementById('annBody').value;
    if(title && body) {
      await push(ref(db, 'announcements'), { title, body, timestamp: serverTimestamp() });
      showToast("Announcement published!");
      document.getElementById('annTitle').value = ''; document.getElementById('annBody').value = '';
    } else { showToast("Fill all fields", "#ef4444"); }
  };

  window.deleteChatMessage = (key) => {
    showModal({ title: "Delete Message?", body: "This will permanently remove the message.", type: "confirm", onConfirm: () => {
      remove(ref(db, 'chats/' + key)); showToast("Message deleted", "#ef4444");
    }});
  };

  window.editChatModal = (key, currentText) => {
    showModal({ title: "Edit Message", body: "Modify text:", isEdit: true, currentVal: currentText, onConfirm: (newText) => {
      if(newText && newText !== currentText) { update(ref(db, 'chats/' + key), { text: newText }); showToast("Updated"); }
    }});
  };

  window.deleteItemConfirm = (path, name) => {
    showModal({ title: `Delete ${name}?`, body: `Are you sure you want to delete this ${name}?`, type: "confirm", onConfirm: () => {
      remove(ref(db, path)); showToast(`${name} deleted`, "#ef4444");
    }});
  };

  window.deleteLearnerConfirm = key => {
    showModal({ title: "Remove Learner?", body: "This revokes all access.", type: "confirm", onConfirm: () => {
      remove(ref(db, 'learners/' + key)); showToast("Learner removed");
    }});
  };

  document.getElementById('provisionBtn').onclick = async () => {
    const email = document.getElementById('newLearnerEmail').value, qual = document.getElementById('qualSelect').value;
    if(email && qual) {
      await push(ref(db, 'learners'), {email, assignedQual: qual, subjects: document.getElementById('learnerSubjects').value, timestamp: serverTimestamp()});
      showModal({ title: "Enrolled!", body: `${email} added.`, type: "success" });
      document.getElementById('newLearnerEmail').value = ''; document.getElementById('qualSelect').value = '';
    }
  };

  document.getElementById('btnPostMat').onclick = async (e) => {
    const file = document.getElementById('matFileInput').files[0];
    if(!file) return; e.target.disabled = true;
    const link = await uploadToCloudinary(file);
    await push(ref(db, 'materials'), {title: document.getElementById('matTitle').value, qual: document.getElementById('matQual').value, link});
    showToast("Material Posted!"); e.target.disabled = false;
  };

  document.getElementById('btnPostAss').onclick = async (e) => {
    const file = document.getElementById('assFileInput').files[0];
    if(!file) return; e.target.disabled = true;
    const link = await uploadToCloudinary(file);
    await push(ref(db, 'assignments'), {title: document.getElementById('assTitle').value, qual: document.getElementById('assQual').value, dueDate: document.getElementById('assDate').value, link});
    showToast("Assignment Issued!"); e.target.disabled = false;
  };

  document.getElementById('btnAddTT').onclick = async () => {
    const day = document.getElementById('ttDay').value, time = document.getElementById('ttTime').value, subject = document.getElementById('ttSubject').value;
    if(day && time && subject) await push(ref(db, 'timetable'), {day, time, subject});
  };

  document.getElementById('btnSendChat').onclick = async () => {
    const text = document.getElementById('chatInput').value;
    if(text) await push(ref(db, 'chats'), { text, sender: auth.currentUser.email, timestamp: serverTimestamp() });
    document.getElementById('chatInput').value = '';
  };

  document.querySelectorAll('.nav-link').forEach(link => {
    link.onclick = () => {
      const target = link.dataset.target;
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById(target).classList.add('active');
      document.getElementById('view-title').textContent = link.querySelector('span').innerText;
    };
  });

  document.getElementById('googleSignInBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
  document.getElementById('signOutBtn').onclick = () => signOut(auth);
</script>
</body>
</html>
